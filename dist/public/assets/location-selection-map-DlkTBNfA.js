import{u as N,r as s,j as a}from"./index-gVtgMtKL.js";const E=async(i,o)=>{try{const u=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${i}&lon=${o}&addressdetails=1`);if(!u.ok)throw new Error("Geocoding failed");const g=await u.json(),l=g.display_name||"",e=g.address||{},t=[];e.house_number&&t.push(e.house_number),e.road&&t.push(e.road),e.neighbourhood&&t.push(e.neighbourhood);const c=t.length>0?t.join(" "):e.road||e.suburb||l.split(",")[0]||"",h=e.city||e.town||e.village||e.municipality||e.state_district||"",n=e.country||"";return{lat:i,lng:o,address:c,city:h,country:n}}catch(u){return console.warn("Reverse geocoding failed:",u),{lat:i,lng:o}}};function T({onLocationSelect:i,selectedLocation:o,className:u=""}){const{t:g}=N(),l=s.useRef(null),e=s.useRef(null),t=s.useRef(null),[c,h]=s.useState(!1),[n,j]=s.useState(null);return s.useEffect(()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(r=>{const{latitude:d,longitude:f}=r.coords;j({lat:d,lng:f})},r=>{console.warn("Geolocation failed:",r.message)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})},[]),s.useEffect(()=>{if(!l.current||e.current)return;let r=null,d=null;const f=()=>{if(typeof window<"u"&&window.L&&l.current){const m=window.L;try{if(!l.current.offsetParent){setTimeout(f,100);return}const L=n?[n.lat,n.lng]:[36.1911,44.0094],k=n?10:8,p=m.map(l.current).setView(L,k);m.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(p),p.on("click",async x=>{try{const{lat:w,lng:v}=x.latlng;t.current&&p.removeLayer(t.current),t.current=m.marker([w,v]).addTo(p),t.current.bindPopup("Getting address...").openPopup();const y=await E(w,v);y.address&&t.current.setPopupContent(`📍 ${y.address}`),i(y)}catch(w){console.warn("Error handling map click:",w),i({lat:x.latlng.lat,lng:x.latlng.lng})}}),e.current=p,h(!0),setTimeout(()=>{e.current&&e.current.invalidateSize()},100)}catch(b){console.error("Error initializing location selection map:",b),h(!1)}}};return window.L?f():(r=setInterval(()=>{window.L&&(r&&(clearInterval(r),r=null),f())},100),d=setTimeout(()=>{r&&(clearInterval(r),r=null),console.warn("Leaflet failed to load within 10 seconds")},1e4)),()=>{if(r&&clearInterval(r),d&&clearTimeout(d),e.current){try{e.current.remove()}catch(m){console.warn("Error cleaning up location selection map:",m)}e.current=null}t.current&&(t.current=null)}},[i,n]),s.useEffect(()=>{e.current&&n&&c&&e.current.setView([n.lat,n.lng],10,{animate:!0,duration:1.5})},[n,c]),s.useEffect(()=>{if(e.current&&o&&c){const r=window.L;t.current&&e.current.removeLayer(t.current),t.current=r.marker([o.lat,o.lng]).addTo(e.current),e.current.setView([o.lat,o.lng],13)}},[o,c]),a.jsxs("div",{className:`relative ${u}`,children:[a.jsx("div",{ref:l,className:"w-full h-full rounded-lg",style:{minHeight:"400px"}}),a.jsxs("div",{className:"absolute top-4 left-4 bg-white dark:bg-gray-800 p-3 rounded-lg shadow-lg border z-10 max-w-xs",children:[a.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[a.jsx("div",{className:"h-2 w-2 bg-blue-500 rounded-full animate-pulse"}),a.jsx("span",{className:"text-sm font-medium",children:"Click to Select Location"})]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Click anywhere on the map to mark your property's location"})]}),!c&&a.jsx("div",{className:"absolute inset-0 bg-gray-100 dark:bg-gray-800 flex items-center justify-center rounded-lg",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-2"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:g("common.loading")})]})})]})}export{T as default};
